# A workflow to run an image scan, translated from a Jenkinsfile
name: Run GCP Image Scan

on:
  workflow_dispatch:
    inputs:
      IMAGE_NAME_TO_SCAN:
        description: 'The full name of the Docker image to scan'
        required: true
        default: 'webgoat/webgoat'
      GCP_PROJECT_ID:
        description: 'GCP Project ID for authentication'
        required: true
        default: 'cispoc'
      ORGANIZATION_ID:
        description: 'Your GCP Organization ID'
        required: true
        default: '714470867684'
      CONNECTOR_ID:
        description: 'The ID for your pipeline connector'
        required: true
        default: 'organizations/714470867684/locations/global/connectors/privatepreviewdemo'
      SCANNER_IMAGE:
        description: 'The Docker image that contains your scanner script'
        required: true
        default: 'us-central1-docker.pkg.dev/ci-plugin/ci-images/scc-artifactguard-scan-image:latest'
      IMAGE_TAG:
        description: 'The Docker image version'
        required: true
        default: 'latest'
      IGNORE_SERVER_ERRORS:
        description: 'Ignore server errors'
        required: false
        type: boolean
        default: false
      VERBOSITY:
        description: 'Verbosity flag'
        required: false
        default: 'HIGH'

jobs:
  image-analysis:
    runs-on: ubuntu-latest
    steps:
      # 1. Authenticate to Google Cloud
      - name: Authenticate to GCP
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      # 2. Set up the gcloud CLI
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ inputs.GCP_PROJECT_ID }}

    # Step 3: Configure Docker for registries (e.g., to pull the scanner image)
      - name: 'Configure Docker for Artifact Registry'
        shell: bash
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
          gcloud auth configure-docker gcr.io --quiet

      # 3.1 Checkout repository (needed so Dockerfile is present)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3.5. Build the local Docker image (added step)
      - name: Build local Docker image
        run: |
          IMAGE_NAME="${{ github.event.inputs.IMAGE_NAME_TO_SCAN }}"
          IMAGE_TAG="${{ github.event.inputs.IMAGE_TAG }}"
          echo "üõ†Ô∏è Building local Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

      # 4. Image Scan
      - name: 'Run Image Analysis Scan'
        if: steps.auth.outcome == 'success'
        run: |
          echo "üì¶ Writing GCP credentials to file..."
          mkdir -p $HOME
          echo "${{ secrets.GCP_CREDENTIALS }}" > "$HOME/gcp-key.json"
          chmod 600 "$HOME/gcp-key.json"
      
          echo "üîë Activating service account..."
          gcloud auth activate-service-account --key-file="$HOME/gcp-key.json"
      
          echo "üê≥ Configuring Docker for Artifact Registry..."
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

          echo "üì¶ Running container from scanner image..."

          SCANNER_IMAGE="${{ github.event.inputs.SCANNER_IMAGE }}"
          GCP_PROJECT_ID="${{ github.event.inputs.GCP_PROJECT_ID }}"
          ORGANIZATION_ID="${{ github.event.inputs.ORGANIZATION_ID }}"
          IMAGE_NAME="${{ github.event.inputs.IMAGE_NAME_TO_SCAN }}"
          IMAGE_TAG="${{ github.event.inputs.IMAGE_TAG }}"
          CONNECTOR_ID="${{ github.event.inputs.CONNECTOR_ID }}"
          VERBOSITY="${{ github.event.inputs.VERBOSITY }}"
          IGNORE_ERRORS="${{ github.event.inputs.IGNORE_SERVER_ERRORS }}"

          exit_code=0

          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ steps.auth.outputs.credentials_file_path }}:/tmp/scc-key.json \
            -e GCLOUD_KEY_PATH=/tmp/scc-key.json \
            -e GCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -e ORGANIZATION_ID="${ORGANIZATION_ID}" \
            -e IMAGE_NAME="${IMAGE_NAME}" \
            -e IMAGE_TAG="${IMAGE_TAG}" \
            -e CONNECTOR_ID="${CONNECTOR_ID}" \
            -e BUILD_TAG="${{ github.workflow }}" \
            -e BUILD_ID="${{ github.run_number }}" \
            -e VERBOSITY="${VERBOSITY}" \
            "${SCANNER_IMAGE}" \
            || exit_code=$?

          echo "Docker run finished with exit code: $exit_code"

          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ Evaluation succeeded: Conformant image."
          elif [ $exit_code -eq 1 ]; then
            echo "‚ùå Scan failed: Non-conformant image (vulnerabilities found)."
            exit 1
          else
            if [ "$IGNORE_ERRORS" = "true" ]; then
              echo "‚ö†Ô∏è Server/internal error occurred (Code: $exit_code), but IGNORE_SERVER_ERRORS=true. Proceeding."
            else
              echo "‚ùå Server/internal error occurred (Code: $exit_code) during evaluation. Set IGNORE_SERVER_ERRORS=true to override."
              exit 1
            fi
          fi
